apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ssl-storage.fullname" . }}
  labels:
    {{- include "ssl-storage.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- $cfg := .Values.sslStorage }}
    server:
      ip: "{{ $cfg.server.ip }}"
      port: {{ $cfg.server.port }}
      daemon: {{ $cfg.server.daemon }}
      {{- if $cfg.server.pidFile }}
      pid_file: "{{ $cfg.server.pidFile }}"
      {{- end }}
      {{- if $cfg.server.workingDirectory }}
      working_directory: "{{ $cfg.server.workingDirectory }}"
      {{- end }}
    logging:
      output: "{{ $cfg.logging.output }}"
      level: "{{ $cfg.logging.level }}"
      syslog_facility: "{{ $cfg.logging.syslogFacility }}"
      syslog_identifier: "{{ $cfg.logging.syslogIdentifier }}"
    storage:
      type: "{{ $cfg.storage.type }}"
      https_path: "{{ $cfg.storage.httpsPath }}"
      {{- if $cfg.storage.redisUrl }}
      redis_url: "{{ $cfg.storage.redisUrl }}"
      {{- end }}
      lock_ttl_seconds: {{ $cfg.storage.lockTtlSeconds }}
      {{- if $cfg.storage.redisSsl.enabled }}
      redis_ssl:
        {{- if $cfg.storage.redisSsl.caCertPath }}
        ca_cert_path: "{{ $cfg.storage.redisSsl.caCertPath }}"
        {{- end }}
        {{- if $cfg.storage.redisSsl.clientCertPath }}
        client_cert_path: "{{ $cfg.storage.redisSsl.clientCertPath }}"
        {{- end }}
        {{- if $cfg.storage.redisSsl.clientKeyPath }}
        client_key_path: "{{ $cfg.storage.redisSsl.clientKeyPath }}"
        {{- end }}
        insecure: {{ $cfg.storage.redisSsl.insecure }}
      {{- end }}
    acme:
      email: "{{ $cfg.acme.email }}"
      development: {{ $cfg.acme.development }}
      dns_lookup:
        max_attempts: {{ $cfg.acme.dnsLookup.maxAttempts }}
        delay_seconds: {{ $cfg.acme.dnsLookup.delaySeconds }}
    domains:
      source: "{{ $cfg.domains.source }}"
      {{- if $cfg.domains.filePath }}
      file_path: "{{ $cfg.domains.filePath }}"
      {{- end }}
      {{- if $cfg.domains.redisKey }}
      redis_key: "{{ $cfg.domains.redisKey }}"
      {{- end }}
      {{- if $cfg.domains.redisUrl }}
      redis_url: "{{ $cfg.domains.redisUrl }}"
      {{- end }}
      {{- if $cfg.domains.httpUrl }}
      http_url: "{{ $cfg.domains.httpUrl }}"
      {{- end }}
      {{- if $cfg.domains.httpRefreshInterval }}
      http_refresh_interval: {{ $cfg.domains.httpRefreshInterval }}
      {{- end }}
      {{- if $cfg.domains.redisSsl.enabled }}
      redis_ssl:
        {{- if $cfg.domains.redisSsl.caCertPath }}
        ca_cert_path: "{{ $cfg.domains.redisSsl.caCertPath }}"
        {{- end }}
        {{- if $cfg.domains.redisSsl.clientCertPath }}
        client_cert_path: "{{ $cfg.domains.redisSsl.clientCertPath }}"
        {{- end }}
        {{- if $cfg.domains.redisSsl.clientKeyPath }}
        client_key_path: "{{ $cfg.domains.redisSsl.clientKeyPath }}"
        {{- end }}
        insecure: {{ $cfg.domains.redisSsl.insecure }}
      {{- end }}
